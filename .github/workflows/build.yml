name: Auto-Update Stable Build

on:
  workflow_dispatch: 
  schedule:
    - cron: '45 22 * * *' # Runs every night at 22:45 UTC

jobs:
  check-and-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout YOUR repo
        uses: actions/checkout@v4

      - name: Fetch Latest EVCC Version
        id: get_version
        run: |
          # Query official repo for latest stable tag (X.Y.Z)
          LATEST=$(git ls-remote --tags --sort='-v:refname' https://github.com/evcc-io/evcc.git | grep -E 'refs/tags/[0-9]+\.[0-9]+\.[0-9]+$' | head -n 1 | cut -d/ -f3)
          echo "tag=$LATEST" >> $GITHUB_OUTPUT
          echo "Latest stable version found: $LATEST"

      - name: Clone and Patch
        run: |
          # Fast clone of the specific version
          git clone --branch ${{ steps.get_version.outputs.tag }} --depth 1 https://github.com/evcc-io/evcc.git evcc_src
          
          AUTH_FILE=evcc_src/util/sponsor/auth.go
          LOGO_FILE=evcc_src/assets/js/components/Footer/Logo.vue

          # 1. Authorization Bypasses
          sed -i '/func IsAuthorized() bool {/,/^}/c \func IsAuthorized() bool { return true }' $AUTH_FILE
          sed -i '/func IsAuthorizedForApi() bool {/,/^}/c \func IsAuthorizedForApi() bool { return true }' $AUTH_FILE
          
          # 2. Set "UNCLEAR" Status with long expiry
          sed -i "/func GetStatus() Status {/,/^}/c \\
          func GetStatus() Status {\\
          	return Status{\\
          		Name:        \"UNCLEAR\",\\
          		ExpiresAt:   time.Now().AddDate(10, 0, 0),\\
          		ExpiresSoon: false,\\
          		Token:       \"ghp_permanent_unlimited_token\",\\
          	}\\
          }" $AUTH_FILE

          # 3. Apply Blue Logo Change (Green #0fdd42 -> Blue #00d2ff)
          if [ -f "$LOGO_FILE" ]; then
            sed -i 's/fill="#0fdd42"/fill="#00d2ff"/g' $LOGO_FILE
            echo "Logo lightning bolt successfully patched to blue."
          fi

          # 4. Clean up Go formatting
          cd evcc_src && go fmt ./util/sponsor/auth.go

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASS }}

      - name: Build and Push
        run: |
          cd evcc_src
          VERSION=${{ steps.get_version.outputs.tag }}
          IMAGE_NAME=${{ secrets.DOCKER_IMAGE }}
          
          # Using the RELEASE=1 build-arg you identified to ensure stable status
          docker buildx build \
            --platform linux/amd64 \
            --tag $IMAGE_NAME:latest \
            --tag $IMAGE_NAME:$VERSION \
            --build-arg RELEASE=1 \
            --push .
