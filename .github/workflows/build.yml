name: MAKKIE - Stable On-Demand Build

on:
  workflow_dispatch: # Manual trigger via GitHub Actions tab

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout YOUR repo
        uses: actions/checkout@v4

      - name: Clone Stable EVCC
        run: |
          # 1. Standard clone
          git clone https://github.com/evcc-io/evcc.git evcc_src
          cd evcc_src
          
          # 2. Force fetch all tags from the remote
          git fetch --tags --force
          
          # 3. Get the latest tag sorted by creator date (newest first)
          # Filter for standard semantic versions (vX.Y.Z)
          LATEST_TAG=$(git tag --sort=-creatordate | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -n 1)
          
          # Fallback to version sort if date sort is empty
          if [ -z "$LATEST_TAG" ]; then
            LATEST_TAG=$(git tag -l "v*" | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n 1)
          fi
          
          if [ -z "$LATEST_TAG" ]; then
            echo "Error: Could not find any tags. Printing all tags for debug:"
            git tag
            exit 1
          fi

          echo "Targeting Stable Version: $LATEST_TAG"
          
          # 4. Switch the source code to that specific stable release
          git checkout $LATEST_TAG

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASS }}

      - name: Apply Bypasses and UI Changes
        run: |
          AUTH_FILE=evcc_src/util/sponsor/auth.go
          LOGO_FILE=evcc_src/assets/js/components/Footer/Logo.vue
          
          # 1. Force authorization functions to return true
          sed -i '/func IsAuthorized() bool {/,/^}/c \func IsAuthorized() bool { return true }' $AUTH_FILE
          sed -i '/func IsAuthorizedForApi() bool {/,/^}/c \func IsAuthorizedForApi() bool { return true }' $AUTH_FILE

          # 2. Set "Not sponsored" status with 10-year expiry
          sed -i "/func GetStatus() Status {/,/^}/c \\
          func GetStatus() Status {\\
          	return Status{\\
          		Name:        \"Not sponsored\",\\
          		ExpiresAt:   time.Now().AddDate(10, 0, 0),\\
          		ExpiresSoon: false,\\
          		Token:       \"ghp_permanent_token_makkie_unlimited\",\\
          	}\\
          }" $AUTH_FILE

          # 3. UI LOGO CHANGE: Green Bolt -> Blue Bolt
          # Replaces your provided green hex (#0fdd42) with electric blue (#00d2ff)
          if [ -f "$LOGO_FILE" ]; then
            sed -i 's/fill="#0fdd42"/fill="#00d2ff"/g' $LOGO_FILE
            echo "Logo lightning bolt successfully patched to blue."
          else
            echo "Error: Logo.vue not found at $LOGO_FILE"
            exit 1
          fi

          # Standardize formatting for Go files
          cd evcc_src && go fmt ./util/sponsor/auth.go

      - name: Build and Push
        run: |
          cd evcc_src
          
          # Determine the version name for Docker tagging
          VERSION=$(git describe --tags --always)
          IMAGE_NAME=${{ secrets.DOCKER_IMAGE }}
          
          echo "Building and Pushing version: $VERSION"
          
          # Run the official Makefile build process
          make docker DOCKER_IMAGE=$IMAGE_NAME DOCKER_TAG=$VERSION
          make docker DOCKER_IMAGE=$IMAGE_NAME DOCKER_TAG=latest
