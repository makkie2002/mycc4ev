name: Auto-update stable build

on:
  workflow_dispatch:
  schedule:
    - cron: '00 23 * * *'

jobs:
  check-and-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout my repo
        uses: actions/checkout@v4

      - name: Fetch latest EVCC version
        id: get_version
        run: |
          # Fetch the latest stable semantic version tag from the official repo
          LATEST=$(git ls-remote --tags --sort='-v:refname' https://github.com/evcc-io/evcc.git | grep -E 'refs/tags/[0-9]+\.[0-9]+\.[0-9]+$' 2>/dev/null | head -n 1 | cut -d/ -f3)
          echo "tag=$LATEST" >> $GITHUB_OUTPUT

      - name: Check if build is needed
        id: check_hub
        run: |
          IMAGE="${{ secrets.DOCKER_IMAGE }}"
          TAG="${{ steps.get_version.outputs.tag }}"
          
          # Get a token to talk to Docker Hub API
          TOKEN=$(curl -s "https://auth.docker.io/token?service=registry.docker.io&scope=repository:$IMAGE:pull" | jq -r .token)
          # Check if the specific version tag already exists
          RESPONSE=$(curl -s -H "Authorization: Bearer $TOKEN" "https://index.docker.io/v2/$IMAGE/manifests/$TAG")
          
          if echo "$RESPONSE" | jq -e '.errors' > /dev/null; then
            echo "needed=true" >> $GITHUB_OUTPUT
            echo "New version $TAG not found on Hub. Proceeding with build..."
          else
            echo "needed=false" >> $GITHUB_OUTPUT
            echo "Version $TAG already exists on Docker Hub. Skipping."
          fi

      - name: Clone and Patch
        # Only runs if version is new OR if you trigger it manually
        if: steps.check_hub.outputs.needed == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          git clone --branch ${{ steps.get_version.outputs.tag }} --depth 1 https://github.com/evcc-io/evcc.git evcc_src
          
          AUTH_FILE=evcc_src/util/sponsor/auth.go
          sed -i '/func IsAuthorized() bool {/,/^}/c \func IsAuthorized() bool { return true }' $AUTH_FILE
          sed -i '/func IsAuthorizedForApi() bool {/,/^}/c \func IsAuthorizedForApi() bool { return true }' $AUTH_FILE
          sed -i '/func GetStatus() Status {/,/^}/c \func GetStatus() Status { return Status{ Name: "【ツ】", ExpiresAt: time.Now().AddDate(20, 0, 0), ExpiresSoon: false, Token: "ghp_permanent_unlimited_token" } }' $AUTH_FILE
          
          cd evcc_src && go fmt ./util/sponsor/auth.go

      - name: Set up Docker Buildx
        if: steps.check_hub.outputs.needed == 'true' || github.event_name == 'workflow_dispatch'
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: steps.check_hub.outputs.needed == 'true' || github.event_name == 'workflow_dispatch'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASS }}

      - name: Build and Push
        if: steps.check_hub.outputs.needed == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          cd evcc_src
          VERSION=${{ steps.get_version.outputs.tag }}
          IMAGE_NAME=${{ secrets.DOCKER_IMAGE }}
          docker buildx build \
            --platform linux/amd64 \
            --tag $IMAGE_NAME:latest \
            --tag $IMAGE_NAME:$VERSION \
            --build-arg RELEASE=1 \
            --push .
