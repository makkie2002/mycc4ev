name: MAKKIE - Permanent Static Build

on:
  workflow_dispatch: # Allows manual triggering

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout YOUR repo
        uses: actions/checkout@v4

      - name: Clone Original EVCC
        run: |
          # Clone the latest source code from the official repository
          git clone https://github.com/evcc-io/evcc.git evcc_src

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASS }}

      - name: Apply Permanent Bypasses
        run: |
          AUTH_FILE=evcc_src/util/sponsor/auth.go
          
          # 1. Force IsAuthorized to always return true
          sed -i '/func IsAuthorized() bool {/,/^}/c \
          func IsAuthorized() bool { return true }' $AUTH_FILE

          # 2. Force IsAuthorizedForApi to always return true
          sed -i '/func IsAuthorizedForApi() bool {/,/^}/c \
          func IsAuthorizedForApi() bool { return true }' $AUTH_FILE

          # 3. Patch GetStatus with name "Not sponsored" and a STATIC token
          sed -i "/func GetStatus() Status {/,/^}/c \\
          func GetStatus() Status {\\
          	return Status{\\
          		Name:        \"Not sponsored\",\\
          		ExpiresAt:   time.Now().AddDate(10, 0, 0),\\
          		ExpiresSoon: false,\\
          		Token:       \"ghp_permanent_token_makkie_unlimited\",\\
          	}\\
          }" $AUTH_FILE

          # 4. Clean up the formatting so the Go compiler is happy
          cd evcc_src && go fmt ./util/sponsor/auth.go

      - name: Verify Patch Content
        run: |
          echo "Checking if patch was applied correctly..."
          cat evcc_src/util/sponsor/auth.go | grep -A 10 "func GetStatus()"

      - name: Build and Push Docker Image
        run: |
          cd evcc_src
          
          IMAGE_NAME=${{ secrets.DOCKER_IMAGE }}
          
          # Get the official version tag (e.g. v0.123.0)
          VERSION=$(git describe --tags --always)
          
          # Run the official build process
          make docker DOCKER_IMAGE=$IMAGE_NAME DOCKER_TAG=$VERSION
          make docker DOCKER_IMAGE=$IMAGE_NAME DOCKER_TAG=latest
