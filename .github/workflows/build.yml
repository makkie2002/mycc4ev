name: MAKKIE - Auto-Update Stable Build

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *' # 2:00 AM UTC daily

jobs:
  check-and-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout YOUR repo
        uses: actions/checkout@v4

      - name: Fetch Latest EVCC Version
        id: get_version
        run: |
          # Query the remote repo for the latest stable tag
          LATEST=$(git ls-remote --tags --sort='-v:refname' https://github.com/evcc-io/evcc.git | grep -E 'refs/tags/[0-9]+\.[0-9]+\.[0-9]+$' | head -n 1 | cut -d/ -f3)
          echo "tag=$LATEST" >> $GITHUB_OUTPUT
          echo "Latest stable version found: $LATEST"

      - name: Clone and Patch
        run: |
          # Specifically clone the tag found in the previous step
          git clone --branch ${{ steps.get_version.outputs.tag }} --depth 1 https://github.com/evcc-io/evcc.git evcc_src
          
          AUTH_FILE=evcc_src/util/sponsor/auth.go
          LOGO_FILE=evcc_src/assets/js/components/Footer/Logo.vue

          # Apply your specific patches
          sed -i '/func IsAuthorized() bool {/,/^}/c \func IsAuthorized() bool { return true }' $AUTH_FILE
          sed -i '/func IsAuthorizedForApi() bool {/,/^}/c \func IsAuthorizedForApi() bool { return true }' $AUTH_FILE
          sed -i "/func GetStatus() Status {/,/^}/c \\
          func GetStatus() Status {\\
          	return Status{\\
          		Name:        \"UNCLEAR\",\\
          		ExpiresAt:   time.Now().AddDate(10, 0, 0),\\
          		ExpiresSoon: false,\\
          		Token:       \"ghp_permanent_unlimited_token\",\\
          	}\\
          }" $AUTH_FILE

          sed -i 's/fill="#0fdd42"/fill="#00d2ff"/g' $LOGO_FILE
          cd evcc_src && go fmt ./util/sponsor/auth.go

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASS }}

      - name: Build and Push
        run: |
          cd evcc_src
          VERSION=${{ steps.get_version.outputs.tag }}
          IMAGE_NAME=${{ secrets.DOCKER_IMAGE }}
          
          make docker DOCKER_IMAGE=$IMAGE_NAME DOCKER_TAG=$VERSION
          make docker DOCKER_IMAGE=$IMAGE_NAME DOCKER_TAG=latest
